# Google Vertex AI Agent with MCP Security Tools

Deploy security-focused AI agents to Google Cloud with integrated access to Chronicle, SOAR, Threat Intelligence, and Security Command Center through the Model Context Protocol (MCP).

## Table of Contents

- [Quick Start](#quick-start)
- [Overview](#overview)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Deployment Workflow](#deployment-workflow)
- [Configuration](#configuration)
- [Usage](#usage)
- [AgentSpace Integration](#agentspace-integration)
- [Makefile Reference](#makefile-reference)
- [Project Structure](#project-structure)
- [Development](#development)
- [Troubleshooting](#troubleshooting)
- [FAQ](#faq)
- [Best Practices](#best-practices)
- [Documentation](#documentation)
- [Support](#support)

## Quick Start

```bash
# Clone and setup
git clone --recurse-submodules https://github.com/your-org/agentic_soc_agentspace.git
cd agentic_soc_agentspace

# Configure environment
cp .env.template .env
# Edit .env with your Google Cloud credentials

# Deploy agent
make agent-engine-deploy
```

For detailed deployment instructions, see the [Deployment Workflow](#deployment-workflow) section below.

### Available Commands

The Makefile provides a comprehensive set of commands for managing your deployment:

![Makefile Help Output](https://private-user-images.githubusercontent.com/121151/491785880-3f34bbdf-fcaa-4343-b803-9f460ba194a0.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTgzMTM5NTgsIm5iZiI6MTc1ODMxMzY1OCwicGF0aCI6Ii8xMjExNTEvNDkxNzg1ODgwLTNmMzRiYmRmLWZjYWEtNDM0My1iODAzLTlmNDYwYmExOTRhMC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwOTE5JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDkxOVQyMDI3MzhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT00ZTM5YTgwYWFmOTg1MWViMDMxMTdhNDVkZmE1NGM3NDcwNjgwZjM4OWM3MjUyZTE2MTIyYjA1ZDNlODI4YTNhJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.s5J7oD0CQ9MFAXvNTBYvEwR5jfq-hFQRas0igrWMGi0)

Run `make help` to see this interactive command reference.

## Overview

This project enables you to:
- Deploy AI agents to Google Vertex AI Agent Engine with security tool access
- Integrate with Google Security Operations (Chronicle) for threat detection
- Connect to SOAR platforms for automated response workflows
- Access Google Threat Intelligence for IOC analysis
- Monitor cloud security posture via Security Command Center

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│   main.py       │───▶│  Vertex AI       │───▶│   MCP Security      │
│   Agent Creator │    │  Agent Engine    │    │   Tools (stdio)     │
└─────────────────┘    └──────────────────┘    └─────────────────────┘
                               │                        │
┌─────────────────┐            │                ┌───────▼───────┐
│test_agent_engine│◀───────────┘                │ • Chronicle   │
│    Testing      │                             │ • SOAR        │
└─────────────────┘                             │ • GTI         │
                                                │ • SCC         │
                                                └───────────────┘
```

## Prerequisites

### System Requirements
- **Python 3.10+** installed locally
- **4GB RAM** minimum
- **Git** with submodules support
- **Google Cloud SDK** installed and configured

### Google Cloud Requirements
- **Active GCP project** with billing enabled
- **Project ID and Project Number** available

### Required APIs
Enable these APIs in your project:
```bash
gcloud services enable aiplatform.googleapis.com
gcloud services enable storage.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable compute.googleapis.com
gcloud services enable discoveryengine.googleapis.com
gcloud services enable securitycenter.googleapis.com  # If using SCC tools
```

### Required IAM Permissions
Your account needs these roles:
- `roles/aiplatform.user` - Create and manage AI Platform resources
- `roles/storage.admin` - Manage staging bucket
- `roles/iam.serviceAccountUser` - Create service accounts for agent
- `roles/discoveryengine.admin` - Manage AgentSpace (if using)
- `roles/securitycenter.admin` - Access Security Command Center (if using)

### Authentication Setup
```bash
gcloud auth application-default login
gcloud config set project YOUR_PROJECT_ID
gcloud auth application-default set-quota-project YOUR_PROJECT_ID
```

## Installation

### 1. Clone Repository
```bash
git clone --recurse-submodules https://github.com/dandye/agentic_soc_agentspace.git
cd agentic_soc_agentspace
```

### 2. Configure Environment
```bash
cp .env.template .env
# Edit .env with your configuration
# NOTE: Some vars, like `AGENT_ENGINE_RESOURCE_NAME`, are generated by make targets (i.e. `make agent-engine-deploy`)
#  so they are not available to you yet.
```

### 3. Install Dependencies
```bash
pip install -r requirements.txt
```

### 4. Deploy Agent
```bash
make agent-engine-deploy
# Or directly: python main.py
```

### 5. Update .env with deployment outputs

1. Set `AGENT_ENGINE_RESOURCE_NAME` in .env (output from deployment)



### 6. Create AgentSpace App (Optional)

1. Navigate to [Google Cloud Console](https://console.cloud.google.com)
2. Go to **Vertex AI > Search & Conversation > Apps**
3. Click **Create App**
4. Select **Agent** as the app type
5. Configure with your preferred settings
6. Copy the App ID and add to `.env` as `AGENTSPACE_APP_ID`

### 7. Register Agent with AgentSpace

```bash
make agentspace-register
```


## Deployment Workflow

The deployment process consists of three stages:

### Stage 1: Prerequisites (User Configuration)
Set these variables in your `.env` file before deployment:

**Required Core Variables:**
- `GCP_PROJECT_ID` - Your Google Cloud Project ID
- `GCP_PROJECT_NUMBER` - Your Google Cloud Project Number (numeric ID)
- `GCP_LOCATION` - Deployment region (e.g., us-central1)
- `GCP_STAGING_BUCKET` - GCS bucket name with gs:// prefix (e.g., gs://my-bucket)
- `GCP_VERTEXAI_ENABLED` - Set to "True" to enable Vertex AI features

**Required Security Tools:**
- Chronicle SIEM: `CHRONICLE_CUSTOMER_ID`, `CHRONICLE_REGION`, `CHRONICLE_SERVICE_ACCOUNT_PATH`
- SOAR: `SOAR_URL`, `SOAR_API_KEY`
- Threat Intelligence: `GTI_API_KEY` (Google Threat Intelligence/VirusTotal)
- RAG Corpus: `RAG_CORPUS_NAME` (full resource name)

### Stage 2: Deployment Outputs
Run `make agent-engine-deploy` and save the generated `AGENT_ENGINE_RESOURCE_NAME` from the output to your `.env`.

### Stage 3: Integration Outputs
Run `make agentspace-register` and save the generated `AGENTSPACE_AGENT_ID` to your `.env`.

## Configuration

See [.env.template](.env.template) for all environment variables with comprehensive documentation. Key variables are documented in the Deployment Workflow section above.

For migration from v1.x to v2.0, see [BREAKING_CHANGES.md](BREAKING_CHANGES.md).

## Usage

### Deploy New Agent
```bash
# Full deployment with all tools
make agent-engine-deploy
```

### Test Deployed Agent
```bash
# After setting AGENT_ENGINE_RESOURCE_NAME in .env from deployment output
python test_agent_engine.py
```

### Example Queries
```python
"List soar cases"
"What are the recent security alerts?"
"Analyze IOCs for domain malicious.com"
"Show Security Command Center findings"
"Investigate user account compromise indicators"
"Find a runbook titled Malware IRP"
```

### Workflow Commands
- `make full-deploy` - Complete standard deployment
- `make full-deploy-with-oauth` - Deployment with OAuth
- `make redeploy-all` - Redeploy and update AgentSpace

## RAG Corpus Management

Create and manage RAG (Retrieval-Augmented Generation) corpora for document search:

```bash
# List all RAG corpora
make rag-list

# List with detailed information
make rag-list VERBOSE=1

# Create a new RAG corpus
make rag-create NAME="Security Runbooks"

# Get corpus information
make rag-info CORPUS_NAME=projects/PROJECT/locations/LOCATION/ragCorpora/CORPUS_ID

# Delete a corpus
make rag-delete CORPUS_NAME=projects/PROJECT/locations/LOCATION/ragCorpora/CORPUS_ID
```

**Note:** After creating a RAG corpus, save the resource name to your `.env` as `RAG_CORPUS_NAME`.

## Data Store Management (Optional - Legacy)

Discovery Engine data stores are available for AgentSpace apps but RAG is the recommended approach:

```bash
# List data stores
make datastore-list

# Create a data store
make datastore-create NAME="Security Data" TYPE=SOLUTION_TYPE_SEARCH
```

## AgentSpace Integration

1. **Create AgentSpace App** - Via [Console](https://console.cloud.google.com)
   - Navigate to Vertex AI > Search & Conversation > Apps
   - Click **Create App** and select **Agent** type
   - Configure with your preferred settings
   - Note: The agent uses RAG for document retrieval, not Discovery Engine data stores
   
2. **Copy App ID** to `.env` as `AGENTSPACE_APP_ID`
3. **Register agent**: `make agentspace-link-agent` (add OAuth with `make oauth-setup` first if needed)
4. **Verify**: `make agentspace-verify`

## Makefile Commands

Run `make help` to see all available commands with descriptions (shown in image above).

### Key Environment Flags
- `FORCE=1` - Skip confirmation prompts
- `V=1` - Verbose output
- `INDEX=n` - Specify item index

**Example:** `FORCE=1 make agentspace-register`

## Project Structure

```
├── main.py                    # Agent creation and deployment
├── test_agent_engine.py       # Testing interface
├── DEPLOYMENT_GUIDE.md        # Detailed deployment instructions
├── requirements.txt           # Python dependencies
├── Makefile                   # Automation workflows
├── .env.template              # Environment template with documentation
├── installation_scripts/
│   ├── install.sh             # Cloud deployment setup (installs `uv`)
│   ├── manage_agent_engine.py # Agent management utilities
│   ├── manage_agentspace.py   # Agentspace configuration
│   └── manage_oauth.py        # OAuth setup utilities
└── mcp-security/              # MCP security servers (submodule)
    └── servers/
        ├── mcp-server-soar/
        ├── mcp-server-secops/
        ├── mcp-server-gti/
        └── mcp-server-scc/
```

## Development

### Customizing the Agent

Edit `main.py` to customize:

```python
# Change model
model = "gemini-2.5-flash"  # or gemini-2.5-pro

# Modify system prompt
instruction = "Your custom security analyst instructions..."

# Select specific tools
tools = [secops_tool, soar_tool]  # Choose tools as needed
```

### Adding New MCP Tools

1. Add tool configuration to `MCPToolset` in `main.py`
2. Update `extra_packages` with server path
3. Modify installation script if needed

### Local Testing

```bash
# Test MCP servers locally
cd mcp-security/servers/secops-soar/secops_soar_mcp
uv run server.py
```
Success looks like:
```
2025-09-15 16:39:39,549 - INFO - __main__ - main - Starting SecOps SOAR MCP server
2025-09-15 16:39:39,817 - INFO - __main__ - get_enabled_integrations_set - No --integrations flag provided. No integrations are enabled.
2025-09-15 16:39:39,818 - INFO - __main__ - register_tools - Starting dynamic tool registration...
2025-09-15 16:39:39,824 - INFO - __main__ - register_tools - Finished scanning marketplace directory.
```
(and then hanging as it is waiting for input)

#### Validate configuration
```bash
python -c "from dotenv import load_dotenv; import os; load_dotenv(); print(os.getenv('GCP_PROJECT_ID'))"
```

## Troubleshooting

### Common Issues & Quick Fixes

| Issue | Solution |
|-------|----------|
| **403/401 Auth Error** | `gcloud auth application-default login` |
| **API not enabled** | `gcloud services enable aiplatform.googleapis.com` |
| **Bucket not found** | `gsutil mb -p $PROJECT_ID gs://$STAGING_BUCKET` |
| **MCP module missing** | `git submodule update --init --recursive` |
| **KeyError: GCP_PROJECT_ID** | Check `.env` exists with correct variable names (v2.0+) |
| **Agent not in AgentSpace** | `make agentspace-verify` then `make agentspace-link-agent` |
| **OAuth expired** | `make oauth-setup CLIENT_SECRET=client_secret.json` |
| **Agent not responding** | Check logs: `gcloud logging tail "resource.type=aiplatform.googleapis.com/ReasoningEngine"` |
| **SOAR connection failed** | Verify URL: `curl -I "${SOAR_URL}/api/external/v1/health"` |

### Quick Debug Commands

```bash
gcloud logging tail "resource.type=aiplatform.googleapis.com/ReasoningEngine"  # Watch logs
make agentspace-test  # Test components
```

## FAQ

**Can I use this without SOAR?**
Yes. All security tool integrations are optional.

**What AI models are supported?**
Gemini 2.0 Flash (default). Configure others in `main.py`.

**How do I update the agent?**
```bash
git pull && make agent-engine-deploy && make agentspace-update
```

**What are the costs?**
Vertex AI charges per API call. Security products require separate licensing.

## Best Practices

- **Security**: Use Secret Manager for credentials, enable audit logging, apply least-privilege IAM
- **Development**: Separate dev/staging/prod projects, version control all configuration
- **Operations**: Set budget alerts, backup configurations, monitor quotas

## Documentation

- [MCP Security Docs](mcp-security/README.md) - Security tool documentation
- [Google Vertex AI Docs](https://cloud.google.com/vertex-ai/docs) - Platform documentation
- [MCP Protocol](https://modelcontextprotocol.io/) - Protocol specification

## Support

### Getting Help
- [GitHub Issues](https://github.com/dandye/agentic_soc_agentspace/issues) - Report bugs or request features
- [Stack Overflow](https://stackoverflow.com/questions/tagged/vertex-ai) - Community support
- [Google Cloud Support](https://console.cloud.google.com/support) - Production issues

### Resources
- [Vertex AI Docs](https://cloud.google.com/vertex-ai/docs) - Google Cloud documentation
- [MCP Protocol](https://modelcontextprotocol.io/) - Model Context Protocol specification
- [Chronicle Docs](https://cloud.google.com/chronicle/docs) - SIEM documentation
- [Security Command Center](https://cloud.google.com/security-command-center/docs) - Cloud security docs

