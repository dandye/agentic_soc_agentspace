name: Update Python Dependencies

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch: # Allows manual triggering
  pull_request:
    types: [opened, synchronize, reopened]
    # Runs on PRs to any branch

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Upgrade requirements.in
        id: upgrade
        run: |
          pur -r requirements.in

      - name: Compile requirements.txt
        id: compile
        run: |
          pip-compile requirements.in

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet requirements.in requirements.txt || echo "changes_detected=true" >> $GITHUB_OUTPUT

      - name: Display dependency update status (PR context)
        if: github.event_name == 'pull_request'
        run: |
          echo "### Dependency Update Check"
          if [[ "${{ steps.check_changes.outputs.changes_detected }}" == "true" ]]; then
            echo "Changes detected in requirements.in:"
            git diff requirements.in
            echo ""
            echo "Updated requirements.txt:"
            git diff requirements.txt
          else
            echo "No dependency updates needed."
          fi

      - name: Run security audit
        if: steps.check_changes.outputs.changes_detected == 'true' && github.event_name != 'pull_request'
        run: |
          pip-audit -r requirements.txt

      - name: Setup Git and Create Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true' && github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="chore/update-python-dependencies-$(date +%Y%m%d%H%M%S)"
          BASE_BRANCH=$(gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name')

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH_NAME
          git add requirements.in requirements.txt
          git commit -m "chore(deps): update python dependencies"
          git push -u origin $BRANCH_NAME

          PR_BODY_FILE=$(mktemp)
          echo 'This PR updates the Python dependencies based on the latest versions available.' > $PR_BODY_FILE
          echo '' >> $PR_BODY_FILE
          echo '## Changes' >> $PR_BODY_FILE
          echo '' >> $PR_BODY_FILE
          echo '### requirements.in' >> $PR_BODY_FILE
          echo '```diff' >> $PR_BODY_FILE
          git diff $BASE_BRANCH requirements.in >> $PR_BODY_FILE
          echo '```' >> $PR_BODY_FILE
          echo '' >> $PR_BODY_FILE
          echo '### requirements.txt' >> $PR_BODY_FILE
          echo '```diff' >> $PR_BODY_FILE
          git diff $BASE_BRANCH requirements.txt | head -n 100 >> $PR_BODY_FILE
          echo '```' >> $PR_BODY_FILE
          echo '' >> $PR_BODY_FILE
          echo '## Security Audit' >> $PR_BODY_FILE
          echo 'Dependencies have been scanned with pip-audit for known vulnerabilities.' >> $PR_BODY_FILE

          gh pr create \
            --title "chore(deps): update python dependencies" \
            --body-file $PR_BODY_FILE \
            --base $BASE_BRANCH \
            --head $BRANCH_NAME \
            --label dependencies,automated
          rm $PR_BODY_FILE
