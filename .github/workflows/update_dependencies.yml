name: Update Python Dependencies

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch: # Allows manual triggering
  pull_request:
    types: [opened, synchronize, reopened]
    # Runs on PRs to any branch

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Upgrade requirements.in
        id: upgrade
        run: |
          pip-upgrade requirements.in

      - name: Compile requirements.txt
        id: compile
        run: |
          pip-compile requirements.in

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet requirements.in || echo "req_in_changed=true" >> $GITHUB_OUTPUT

      - name: Display dependency update status (PR context)
        if: github.event_name == 'pull_request'
        run: |
          echo "### Dependency Update Check"
          if [[ "${{ steps.check_changes.outputs.req_in_changed }}" == "true" ]]; then
            echo "Changes detected in requirements.in:"
            git diff requirements.in
            echo ""
            echo "Updated requirements.txt:"
            git diff requirements.txt
          else
            echo "No dependency updates needed."
          fi

      - name: Setup Git and Create Pull Request
        if: steps.check_changes.outputs.req_in_changed == 'true' && github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="chore/update-python-dependencies-$(date +%Y%m%d%H%M%S)"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH_NAME
          git add requirements.in requirements.txt
          git commit -m "chore(deps): update python dependencies"
          git push -u origin $BRANCH_NAME

          PR_BODY_FILE=$(mktemp)
          echo 'This PR updates the Python dependencies based on the latest versions available.' > $PR_BODY_FILE
          echo '- Updates `requirements.in` with the latest package versions.' >> $PR_BODY_FILE
          echo '- Re-compiles `requirements.txt` from the updated `requirements.in`.' >> $PR_BODY_FILE

          gh pr create \
            --title "Update Python Dependencies" \
            --body-file $PR_BODY_FILE \
            --base main \
            --head $BRANCH_NAME
          rm $PR_BODY_FILE
