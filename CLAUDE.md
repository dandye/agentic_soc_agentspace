# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a security operations (SOC) agent system built with Google Vertex AI Agent Development Kit (ADK). It deploys AI agents to Google Cloud with integrated access to Chronicle SIEM, SOAR, Google Threat Intelligence, Security Command Center, and RAG-based runbook retrieval through the Model Context Protocol (MCP).

## Common Commands

### Development and Testing

Local development with ADK Web (no deployment needed):
```bash
cd soc_agent
GOOGLE_GENAI_USE_VERTEXAI=True \
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json \
GOOGLE_CLOUD_PROJECT=your-project-id \
GOOGLE_CLOUD_LOCATION=us-central1 \
adk web
```

Run tests:
```bash
python test_agent_engine.py  # Test deployed agent
python test_schema_validation.py  # Validate MCP schemas
```

### Deployment Commands

Deploy agent to Agent Engine (using Makefile):
```bash
make agent-engine-deploy  # Initial deployment
make agent-engine-redeploy  # Redeploy existing agent
make agentspace-register  # Register with AgentSpace
make full-deploy-with-oauth  # Complete deployment with OAuth
```

Deploy agent to Agent Engine (using Python CLI):
```bash
python manage.py agent-engine list
python manage.py agentspace register
python manage.py workflow full-deploy
python manage.py workflow status
```

### RAG Corpus Management

```bash
make rag-list  # List all RAG corpora
make rag-create NAME="Security Runbooks"  # Create new corpus
python manage.py rag list --verbose
python manage.py rag create "name" --description "desc"
```

### Environment Management

```bash
make setup  # Setup environment
make check-prereqs  # Validate configuration
make status  # Check system status
python manage.py setup  # Alternative Python CLI setup
```

## Architecture

### Core Agent Structure

The agent is defined in `soc_agent/agent.py` and exports a `root_agent` for ADK compatibility:

- **Model**: `gemini-2.5-pro` (configurable in agent.py)
- **Tools**: 4 MCP toolsets + RAG retrieval
  - Chronicle/SIEM (secops_mcp)
  - SOAR (secops_soar_mcp)
  - Google Threat Intelligence (gti_mcp)
  - Security Command Center (scc)
  - RAG retrieval (Vertex AI RAG)

### MCP Integration Pattern

MCP servers are configured as `McpToolset` instances with stdio connections:

```python
tool = McpToolset(
    connection_params=StdioConnectionParams(
        server_params=StdioServerParameters(
            command='uv',
            args=["--directory", "./mcp-security/server/...", "run", "server.py"],
            env={"KEY": "value"}
        ),
        timeout=60000
    ),
    errlog=None
)
```

All MCP servers are in the `mcp-security/` git submodule and use `uv` for dependency management.

### Environment Configuration

The project uses a staged configuration approach:

**Stage 1 (Prerequisites)**: Set in `.env` before deployment
- `GCP_PROJECT_ID`, `GCP_PROJECT_NUMBER`, `GCP_LOCATION`
- `GCP_STAGING_BUCKET` (with `gs://` prefix)
- `CHRONICLE_*`, `SOAR_*`, `GTI_API_KEY`, `RAG_CORPUS_ID`

**Stage 2 (Deployment Outputs)**: Generated by `make agent-engine-deploy`
- `AGENT_ENGINE_RESOURCE_NAME`

**Stage 3 (Integration Outputs)**: Generated by `make agentspace-register`
- `AGENTSPACE_AGENT_ID`, `OAUTH_AUTH_ID`

### Dual CLI Interface

The project has two management interfaces with identical functionality:

1. **Makefile** - Traditional make-based interface
   - `make agent-engine-list`, `make agentspace-register`, etc.
   - Uses Python scripts in `installation_scripts/`

2. **Python CLI (manage.py)** - Typer-based unified CLI
   - `python manage.py agent-engine list`
   - `python manage.py agentspace register`
   - Better for cross-platform, type safety, autocomplete

Both interfaces call the same underlying Python modules in `installation_scripts/`.

## Project Structure

```
.
├── soc_agent/              # ADK agent module
│   └── agent.py           # Main agent definition (exports root_agent)
├── manage.py              # Unified Typer CLI (alternative to Makefile)
├── installation_scripts/  # Management utilities
│   ├── manage_agent_engine.py
│   ├── manage_agentspace.py
│   ├── manage_oauth.py
│   ├── manage_rag.py
│   └── manage_datastore.py
├── mcp-security/          # Git submodule with MCP servers
│   └── server/
│       ├── secops/        # Chronicle SIEM MCP server
│       ├── secops-soar/   # SOAR MCP server
│       ├── gti/           # Threat Intelligence MCP server
│       └── scc/           # Security Command Center MCP server
├── Makefile              # Make-based management interface
├── .env                  # Environment configuration (not in git)
├── .env.example          # Environment template with docs
└── requirements.txt      # Python dependencies
```

## Key Implementation Details

### Agent Creation Flow

1. `soc_agent/agent.py` defines `create_agent()` function
2. Loads environment from `.env` using `python-dotenv`
3. Initializes Vertex AI with project/location/staging bucket
4. Configures 4 MCP toolsets + RAG retrieval
5. Creates Agent instance with tools and instruction
6. Exports as `root_agent` at module level

### MCP Server Execution

MCP servers run as stdio subprocesses managed by ADK:
- Command: `uv` (universal Python package manager)
- Pattern: `uv --directory <server_path> run server.py`
- Environment variables passed via `env` dict in StdioServerParameters
- Service account credentials passed as filename (SECOPS_SA_PATH)

### RAG Corpus Integration

RAG retrieval uses Vertex AI RAG service:
- Corpus ID format: `projects/{project}/locations/{location}/ragCorpora/{corpus_id}`
- Configured via `VertexAiRagRetrieval` tool
- Retrieves runbooks, IRPs, common steps, personas
- Configurable similarity threshold and top-k results

## Modifying the Agent

### Changing the Model

Edit `soc_agent/agent.py`:
```python
agent = Agent(
    model="gemini-2.5-flash",  # or gemini-2.5-pro, gemini-1.5-pro, etc.
    ...
)
```

### Adding/Removing MCP Tools

Edit `soc_agent/agent.py`:
1. Add/remove tool configuration in `create_agent()`
2. Add environment variables to `.env`
3. Update `tools` list before creating Agent

### Updating System Prompt

Edit the `instruction` parameter in `Agent()` creation in `soc_agent/agent.py`.

## Testing Approach

### Local Testing (Fastest)
```bash
cd soc_agent && adk web
```
Opens web UI at http://localhost:8000 - no deployment required, instant iteration.

### Integration Testing
```bash
python test_agent_engine.py
```
Tests the deployed Agent Engine instance using the resource name from `.env`.

### MCP Server Testing
```bash
cd mcp-security/server/secops/secops_mcp
uv run server.py
```
Tests individual MCP server in isolation.

## Dependencies and Tools

- **Python 3.10+** required
- **uv**: Used to run all MCP servers (installed in MCP server directories)
- **Google ADK**: Agent development framework (`google-adk`)
- **Vertex AI SDK**: `google-cloud-aiplatform[agent-engines]`
- **MCP Protocol**: Model Context Protocol client/server (`mcp`)

## Troubleshooting

Common issues:
- **"AGENT_ENGINE_RESOURCE_NAME not set"**: Run `make agent-engine-deploy` first
- **MCP server timeout**: Check service account path and credentials
- **RAG retrieval not working**: Verify `RAG_CORPUS_ID` format and permissions
- **OAuth expired**: Run `make oauth-setup CLIENT_SECRET=client_secret.json`

Debug commands:
```bash
make status  # Check all configuration
gcloud logging tail "resource.type=aiplatform.googleapis.com/ReasoningEngine"  # View logs
python -c "from dotenv import load_dotenv; import os; load_dotenv(); print(os.getenv('GCP_PROJECT_ID'))"  # Verify env
```

## Important Notes

- This is a **worktree** (`rag_runbooks_testing` branch) - changes here are isolated
- The `mcp-security/` directory is a **git submodule** - update with `git submodule update --init --recursive`
- Edit source files in `mcp-security/`, not in `.claude/rules_bank/` or `.clinerules/rules_bank/` (those are symlinks)
- Always validate `.env` configuration before deployment
- MCP servers expect specific environment variable names (SOAR_APP_KEY, VT_APIKEY, SECOPS_SA_PATH)
- Service account JSON must be accessible to both the agent and MCP servers
